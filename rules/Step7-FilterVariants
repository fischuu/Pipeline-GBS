rule Step7_FilterVariants:
    """
    Filter variants and call genotypes.
    """
    input:
        "%s/FASTQ/TRIMMED/GSC.MasterMatrix.txt" % (config["project-folder"])
    output:
        filtered="%s/FASTQ/TRIMMED/variants/GSC.GenoMatrix.txt" % (config["project-folder"]),
        unfiltered="%s/FASTQ/TRIMMED/variants/GSC.GenoMatrix.unfiltered.txt" % (config["project-folder"])
    params:
        input=config["params"]["step7"]["input"],
        out=config["params"]["step7"]["out"],
        unfiltered=config["params"]["step7"]["unfiltered"],
        p=config["params"]["step7"]["p"],
        mnHoDepth0=config["params"]["step7"]["mnHoDepth0"],
        mnHoDepth1=config["params"]["step7"]["mnHoDepth1"],
        mnHetDepth=config["params"]["step7"]["mnHetDepth"],
        altStrength=config["params"]["step7"]["altStrength"],
        mnAlleleRatio=config["params"]["step7"]["mnAlleleRatio"],
        mnCall=config["params"]["step7"]["mnCall"],
        mnAvgDepth=config["params"]["step7"]["mnAvgDepth"],
        mxAvgDepth=config["params"]["step7"]["mxAvgDepth"],
        wd="%s/FASTQ/TRIMMED" % config["project-folder"],
        pipefolder=config["pipeline-folder"]
    log:
        "%s/logs/step7.log" % (config["project-folder"])
    benchmark:
        "%s/benchmark/step7.benchmark.tsv" % (config["project-folder"])
    conda:"envs/gbs.yaml"
    singularity: config["singularity"]["gbs"]
    shell:"""
        #******PARAMETERS*****
        # -in 	Discovery master matrix input file. The output from last step 	File 	GSC.MasterMatrix.txt
        # -out 	Genotyping matrix for the population 	Output file 	GSC.GenoMatrix.txt
        # -p 	Identify SNPs only (snp) or SNPs + indels (indel) 	String 	--
        # -mnHoDepth0 	Minimum depth required for calling a homozygote when the alternative allele depth = 0 	Numeric 	5
        # -mnHoDepth1 	Minimum depth required for calling a homozygote when the alternative allele depth = 1 	Numeric 	20
        # -mnHetDepth 	Minimum depth required for each allele when calling a heterozygote 	Numeric 	3
        # -altStrength 	Across the population for a given putative bi-allelic variant, this alternate allele strength parameter is the minimum proportion of non-primary allele reads that are the secondary allele 	Numeric 	0.8
        # -mnAlleleRatio 	Minimum required ratio of less frequent allele depth to more frequent allele depth 	Numeric 	0.25
        # -mnCall 	Minimum acceptable proportion of genotyped individuals to retain a variant 	Numeric 	0.75
        # -mnAvgDepth 	Minimum average depth of an acceptable variant 	Numeric 	3
        # -mxAvgDepth 	Maximum average depth of an acceptable variant 	Numeric 	200

        cd {params.wd}
        perl {params.pipefolder}/scripts/GBS-SNP-CROP-7.pl -in {params.input} -out {params.out} -p {params.p} -mnHoDepth0 {params.mnHoDepth0} -mnHoDepth1 {params.mnHoDepth1} -mnHetDepth {params.mnHetDepth} -altStrength {params.altStrength} -mnAlleleRatio {params.mnAlleleRatio} -mnCall {params.mnCall} -mnAvgDepth {params.mnAvgDepth} -mxAvgDepth {params.mxAvgDepth} &> {log}
        perl {params.pipefolder}/scripts/GBS-SNP-CROP-7.pl -in {params.input} -out {params.unfiltered} -p {params.p} -mnHoDepth0 0 -mnHoDepth1 0 -mnHetDepth 0 -altStrength 0 -mnAlleleRatio 0 -mnCall 0 -mnAvgDepth 0 -mxAvgDepth 1000000 &> {log}
  	"""

if config["genome"] == "":
    print(f"No reference genome provided, skipping the star indexing step for reference genome")
else:
    rule Step7_0_FilterVariants_reference:
        """
        Filter variants and call genotypes using the reference genome.
        """
        input:
            "%s/MPILEUP/mpileup_reference/GSC.MasterMatrix.txt" % (config["project-folder"])
        output:
            filtered="%s/MPILEUP/mpileup_reference/variants/GSC.GenoMatrix.txt" % (config["project-folder"]),
            unfiltered="%s/MPILEUP/mpileup_reference/variants/GSC.GenoMatrix.unfiltered.txt" % (config["project-folder"])
        params:
            input=config["params"]["step7"]["input"],
            out=config["params"]["step7"]["out"],
            unfiltered=config["params"]["step7"]["unfiltered"],
            p=config["params"]["step7"]["p"],
            mnHoDepth0=config["params"]["step7"]["mnHoDepth0"],
            mnHoDepth1=config["params"]["step7"]["mnHoDepth1"],
            mnHetDepth=config["params"]["step7"]["mnHetDepth"],
            altStrength=config["params"]["step7"]["altStrength"],
            mnAlleleRatio=config["params"]["step7"]["mnAlleleRatio"],
            mnCall=config["params"]["step7"]["mnCall"],
            mnAvgDepth=config["params"]["step7"]["mnAvgDepth"],
            mxAvgDepth=config["params"]["step7"]["mxAvgDepth"],
            wd="%s/MPILEUP/mpileup_reference" % config["project-folder"],
            pipefolder=config["pipeline-folder"]
        log:
            "%s/logs/step7_0.log" % (config["project-folder"])
        benchmark:
            "%s/benchmark/step7_0.benchmark.tsv" % (config["project-folder"])
        conda:"envs/gbs.yaml"
        singularity: config["singularity"]["gbs"]
        shell:"""
            #******PARAMETERS*****
            # -in 	Discovery master matrix input file. The output from last step 	File 	GSC.MasterMatrix.txt
            # -out 	Genotyping matrix for the population 	Output file 	GSC.GenoMatrix.txt
            # -p 	Identify SNPs only (snp) or SNPs + indels (indel) 	String 	--
            # -mnHoDepth0 	Minimum depth required for calling a homozygote when the alternative allele depth = 0 	Numeric 	5
            # -mnHoDepth1 	Minimum depth required for calling a homozygote when the alternative allele depth = 1 	Numeric 	20
            # -mnHetDepth 	Minimum depth required for each allele when calling a heterozygote 	Numeric 	3
            # -altStrength 	Across the population for a given putative bi-allelic variant, this alternate allele strength parameter is the minimum proportion of non-primary allele reads that are the secondary allele 	Numeric 	0.8
            # -mnAlleleRatio 	Minimum required ratio of less frequent allele depth to more frequent allele depth 	Numeric 	0.25
            # -mnCall 	Minimum acceptable proportion of genotyped individuals to retain a variant 	Numeric 	0.75
            # -mnAvgDepth 	Minimum average depth of an acceptable variant 	Numeric 	3
            # -mxAvgDepth 	Maximum average depth of an acceptable variant 	Numeric 	200
    
            cd {params.wd}
            perl {params.pipefolder}/scripts/GBS-SNP-CROP-7.pl -in {params.input} -out {params.out} -p {params.p} -mnHoDepth0 {params.mnHoDepth0} -mnHoDepth1 {params.mnHoDepth1} -mnHetDepth {params.mnHetDepth} -altStrength {params.altStrength} -mnAlleleRatio {params.mnAlleleRatio} -mnCall {params.mnCall} -mnAvgDepth {params.mnAvgDepth} -mxAvgDepth {params.mxAvgDepth} &> {log}
            perl {params.pipefolder}/scripts/GBS-SNP-CROP-7.pl -in {params.input} -out {params.unfiltered} -p {params.p} -mnHoDepth0 0 -mnHoDepth1 0 -mnHetDepth 0 -altStrength 0 -mnAlleleRatio 0 -mnCall 0 -mnAvgDepth 0 -mxAvgDepth 1000000 &> {log}
      	"""
        
    
